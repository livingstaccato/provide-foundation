name: ðŸš€ Release & Deployment

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Deployment target'
        required: true
        default: 'none'
        type: choice
        options:
          - 'none'
          - 'test-pypi'
          - 'pypi'
      force_deploy:
        description: 'Force deployment (bypass checks)'
        required: false
        default: false
        type: boolean

env:
  UV_VERSION: "0.9.13"

jobs:
  # ==================================================================================
  # ðŸ” Pre-Release Validation
  # ==================================================================================
  validate:
    name: ðŸ” Pre-Release Validation
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.11", "3.12"]
    if: github.event.inputs.force_deploy != 'true'
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: âš¡ Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}

      - name: ðŸ“¦ Setup Environment
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e .
          uv pip install "provide-testkit[standard,advanced-testing,typecheck,utils,build] @ git+https://github.com/livingstaccato/provide-testkit.git@main"
          uv sync --all-groups --dev --prerelease=allow

      - name: ðŸ§ª Run Critical Tests
        run: |
          source .venv/bin/activate
          pytest tests/ -n auto --cov=provide.foundation --cov-fail-under=95 -x
        continue-on-error: true

      - name: ðŸš€ Run Performance Validation
        run: |
          source .venv/bin/activate
          python scripts/benchmark_performance.py

      - name: ðŸ” Version Consistency Check
        run: |
          source .venv/bin/activate
          python scripts/version_checker.py

  # ==================================================================================
  # ðŸ“¦ Download CI Artifacts
  # ==================================================================================
  get-artifacts:
    name: ðŸ“¦ Download CI Artifacts
    runs-on: ubuntu-latest
    needs: [validate]
    if: always() && (needs.validate.result == 'success' || github.event.inputs.force_deploy == 'true')
    steps:
      - name: ðŸ“¤ Download CI Package Artifacts
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: ci.yml
          name: package-dist
          path: dist/
          if_no_artifact_found: fail

      - name: âš¡ Install uv for validation
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}

      - name: ðŸ” Validate Downloaded Package
        run: |
          ls -la dist/
          uv pip install twine
          python -m twine check dist/*

      - name: ðŸ“ˆ Re-upload Package Artifacts for Release
        uses: actions/upload-artifact@v4
        with:
          name: release-package-${{ github.sha }}
          path: dist/

  # ==================================================================================
  # ðŸ§ª Deploy to Test PyPI
  # ==================================================================================
  deploy-test-pypi:
    name: ðŸ§ª Deploy to Test PyPI
    runs-on: ubuntu-latest
    needs: [get-artifacts]
    if: github.event.inputs.deploy_target == 'test-pypi'
    environment: test-pypi
    steps:
      - name: âš¡ Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}

      - name: ðŸ“¤ Download Package Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-package-${{ github.sha }}
          path: dist/

      - name: ðŸ§ª Publish to Test PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          verbose: true
          print-hash: true

      - name: ðŸ“ Test Installation from Test PyPI
        run: |
          for i in {1..45}; do echo -n "$i "; sleep 1; done;
          uv venv .venv_test_install
          source .venv_test_install/bin/activate
          uv pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ provide-foundation
          python -c "from provide.foundation import logger; logger.info('Test PyPI installation successful')"

  # ==================================================================================
  # ðŸš€ Deploy to Production PyPI
  # ==================================================================================
  deploy-pypi:
    name: ðŸš€ Deploy to Production PyPI
    runs-on: ubuntu-latest
    needs: [get-artifacts]
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.deploy_target == 'pypi'
    environment: pypi
    permissions:
      contents: write
      id-token: write  # For trusted publishing
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¤ Download Package Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-package-${{ github.sha }}
          path: dist/

      - name: ðŸš€ Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          verbose: true
          print-hash: true

      - name: ðŸ·ï¸ Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
          generate_release_notes: true
          append_body: |

            ## ðŸ“¦ Installation

            ```bash
            uv install provide-foundation
            ```

            ## ðŸš€ What's New

            See the [changelog](CHANGELOG.md) for detailed changes.

  # ==================================================================================
  # ðŸ“‹ Deployment Summary
  # ==================================================================================
  summary:
    name: ðŸ“‹ Deployment Summary
    runs-on: ubuntu-latest
    needs: [validate, get-artifacts, deploy-test-pypi, deploy-pypi]
    if: always()
    steps:
      - name: ðŸ“Š Report Deployment Results
        run: |
          echo "## ðŸš€ Foundation Telemetry Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Validation | ${{ needs.validate.result == 'success' && 'âœ… Pass' || needs.validate.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Get Artifacts | ${{ needs.get-artifacts.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Test PyPI | ${{ needs.deploy-test-pypi.result == 'success' && 'âœ… Deployed' || needs.deploy-test-pypi.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Production PyPI | ${{ needs.deploy-pypi.result == 'success' && 'âœ… Deployed' || needs.deploy-pypi.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
